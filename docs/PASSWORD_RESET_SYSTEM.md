# Password Reset System Documentation

## Overview

Email-based password reset system using 6-character alphanumeric codes with security features including rate limiting, code expiration, and failed attempt tracking.

---

## Architecture

### Models

**PasswordReset** (`backend/models/passwordReset.js`)

```javascript
{
  email: String (required, min 9 chars),
  resetCode: String (required, 6 alphanumeric chars),
  expiresAt: Date (required, 15 minutes from creation),
  attempts: Number (required, starts at 0, max 5),
  createdAt: Date (auto-generated by timestamps),
  updatedAt: Date (auto-generated by timestamps)
}
```

**TTL Index**: `{ expiresAt: 1 }` with `expireAfterSeconds: 0`

- Automatically deletes expired reset documents from MongoDB

---

## API Endpoints

### 1. Request Password Reset

**Endpoint**: `POST /api/auth/forgot-password/request`

**Request Body**:

```json
{
  "email": "user@example.com"
}
```

**Success Response** (200):

```json
"Password reset email sent"
```

**Error Responses**:

- `401`: Invalid email (user not found)
- `429`: Too many reset requests (3/day limit)

**What it does**:

1. Validates user exists
2. Checks rate limit (3 requests per email per 24 hours)
3. Generates 6-character alphanumeric code
4. Creates PasswordReset document with 15-minute expiration
5. Sends code via email
6. Returns success message

**Security Features**:

- Rate limiting: Max 3 requests per email per day (resets at midnight UTC)
- Code generation: Uses `crypto.randomInt()` for cryptographic randomness
- Characters: Alphanumeric (A-Z, a-z, 0-9) for readability

---

### 2. Verify Reset Code

**Endpoint**: `POST /api/password-reset/verify`

**Request Body**:

```json
{
  "email": "user@example.com",
  "code": "A4K9P2"
}
```

**Success Response** (200):

```json
"Code validated"
```

**Error Responses**:

- `401`: Invalid email (no reset request found)
- `401`: Reset code expired (>15 minutes old)
- `401`: Too many attempts (>5 failed attempts)
- `401`: Incorrect code

**What it does**:

1. Finds PasswordReset document by email
2. Checks if code has expired
3. Checks if max attempts exceeded
4. Compares submitted code with stored code
5. Increments attempts counter if incorrect
6. Returns validation result

**Security Features**:

- Max 5 failed verification attempts per code
- Expired codes rejected (15-minute window)
- Attempt counter persists across requests

---

### 3. Reset Password

**Endpoint**: `POST /api/password-reset/reset`

**Request Body**:

```json
{
  "email": "user@example.com",
  "resetCode": "A4K9P2",
  "newPassword": "newSecurePassword123"
}
```

**Success Response** (200):

```json
"User's password updated"
```

**Error Responses**:

- `400`: Email and password required
- `401`: Incorrect code

**What it does**:

1. Finds PasswordReset document by email
2. Verifies reset code matches
3. Hashes new password with bcrypt (10 salt rounds)
4. Updates user's passwordHash
5. Deletes PasswordReset document
6. Returns success message

**Security Features**:

- Password hashing with bcrypt
- Reset document deleted after successful reset (one-time use)
- Re-verifies code before password change

---

## Email Service

**Configuration** (`backend/utils/mailer.js`)

Uses **Nodemailer** with Gmail SMTP:

```javascript
{
  host: "smtp.gmail.com",
  port: 587,
  secure: false,
  auth: {
    user: process.env.EMAIL,
    pass: process.env.EMAIL_PASSWORD
  }
}
```

**Email Format**:

- **From**: `cadenceelaina.journal.reset@gmail.com`
- **Subject**: "Journal Password Reset Code"
- **Body**: "Your password reset code is: {CODE}"

**Environment Variables** (`.env`):

```
EMAIL=cadenceelaina.journal.reset@gmail.com
EMAIL_PASSWORD={Gmail App Password}
```

---

## Security Features Summary

| Feature              | Implementation       | Purpose             |
| -------------------- | -------------------- | ------------------- |
| Rate Limiting        | 3 requests/email/day | Prevent spam/abuse  |
| Code Expiration      | 15 minutes           | Limit attack window |
| Failed Attempts      | Max 5 per code       | Prevent brute force |
| Auto Cleanup         | TTL index            | Remove stale data   |
| One-time Use         | Delete after reset   | Prevent code reuse  |
| Cryptographic Random | crypto.randomInt()   | Unpredictable codes |
| Password Hashing     | bcrypt (10 rounds)   | Secure storage      |

---

## Flow Diagram

```
User enters email
    ↓
Check if user exists
    ↓
Check rate limit (3/day)
    ↓
Generate 6-char code
    ↓
Save to PasswordReset (15min expiry)
    ↓
Send email with code
    ↓
User receives email
    ↓
User enters code
    ↓
Verify code (check expiry, attempts)
    ↓
Code valid?
    ↓ Yes
User enters new password (2x)
    ↓
Hash password
    ↓
Update User.passwordHash
    ↓
Delete PasswordReset document
    ↓
Success - redirect to login
```

---

## Frontend Implementation (Pending)

### Multi-Step Form Flow

**Step 1: Enter Email**

- Input: Email address
- Button: "Send Reset Code"
- Success: Show Step 2

**Step 2: Enter Code**

- Input: 6-character code
- Button: "Verify Code"
- Show: "Didn't receive? Resend (wait 5 min)"
- Success: Show Step 3

**Step 3: New Password**

- Input: New password
- Input: Confirm password
- Button: "Reset Password"
- Success: Redirect to login with success message

### UI Components Needed

- `ResetAuthForm.jsx` - Multi-step form with state management
- `CodeInput.jsx` - 6-character input (optional: split into 6 fields)
- `PasswordStrengthMeter.jsx` - Visual password strength indicator
- Validation: Email format, password match, code format

---

## Testing Checklist

### Backend Tests

- [ ] Request reset with valid email
- [ ] Request reset with invalid email (should fail)
- [ ] Request 4th reset in same day (should fail with 429)
- [ ] Verify code immediately after request
- [ ] Verify expired code (>15 min old, should fail)
- [ ] Verify code with 6 wrong attempts (should fail)
- [ ] Reset password with valid code
- [ ] Reset password with already-used code (should fail)
- [ ] Verify email is sent and received
- [ ] Verify TTL cleanup (wait 15+ min, check DB)

### Frontend Tests (Pending)

- [ ] Email step shows validation errors
- [ ] Code step accepts 6-char input only
- [ ] Password step validates matching passwords
- [ ] Success states navigate correctly
- [ ] Error messages display properly
- [ ] Resend button has 5-minute cooldown

---

## Known Limitations

1. **Email Deliverability**: Gmail SMTP may flag emails as spam

   - Solution: Use dedicated email service (SendGrid, Resend) in production

2. **No Email Template**: Plain text emails only

   - Future: HTML email templates with branding

3. **Single Language**: English only

   - Future: i18n support

4. **No SMS Option**: Email only
   - Future: Add SMS verification as alternative

---

## Future Enhancements

- [ ] HTML email templates with CSS styling
- [ ] SMS-based reset option (Twilio)
- [ ] Magic link alternative (click link instead of code)
- [ ] Remember device (skip reset for trusted devices)
- [ ] Security notifications (alert user when password changed)
- [ ] Multi-language support
- [ ] Admin dashboard to monitor reset requests

---

## Troubleshooting

**Problem**: Email not sending

- Check `.env` has correct `EMAIL` and `EMAIL_PASSWORD`
- Verify Gmail App Password is valid
- Check spam folder
- Test SMTP connection manually

**Problem**: Codes expiring too fast

- Verify server timezone matches expectations
- Check `Date.now()` calculation in code generation

**Problem**: Rate limit not working

- Verify MongoDB `createdAt` field is indexed
- Check system time (rate limit uses UTC midnight)

**Problem**: TTL cleanup not working

- Verify TTL index exists: `db.passwordresets.getIndexes()`
- MongoDB TTL runs every 60 seconds (not instant)
- Check MongoDB version supports TTL indexes

---

## Code References

**Files**:

- `backend/models/passwordReset.js` - Model definition
- `backend/controllers/auth.js` - Reset endpoints (lines 57-190)
- `backend/utils/mailer.js` - Email service
- `backend/utils/config.js` - Environment config

**Dependencies**:

- `nodemailer` - Email sending
- `bcrypt` - Password hashing
- `crypto` - Cryptographic random number generation

**Environment Variables**:

- `EMAIL` - Sender email address
- `EMAIL_PASSWORD` - Gmail App Password
